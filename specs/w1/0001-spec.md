# Project Alpha 需求与设计文档

## 1. 概述
- 目标：提供一个基于标签对 ticket 进行分类与管理的 Web 应用，后端使用 FastAPI + Postgres，前端使用 Typescript/Vite/Tailwind/Shadcn，无用户体系，所有操作视为同一“当前用户”。
- 核心能力：创建/编辑/删除/完成/取消完成 ticket，为 ticket 添加/删除标签，按标签浏览与按标题搜索。
- 非目标：权限管理、多租户、富文本编辑、文件/图片上传、推送通知。

## 2. 角色与权限
- 单一角色：当前用户。
- 权限：可创建/编辑/删除/完成/取消完成 ticket，管理标签，按标签和标题筛选/搜索。

## 3. 关键用户流程
- 创建 ticket：输入标题（必填）、描述（选填），可选标签 -> 保存 -> 列表可见。
- 编辑 ticket：更新标题/描述/标签 -> 保存并刷新列表。
- 标记完成/取消完成：在列表或详情中切换状态。
- 删除 ticket：从列表/详情删除（物理删除）。
- 标签管理：在创建/编辑时新增标签或选择已有标签；在列表侧边栏/过滤器中切换标签查看。
- 按标签浏览：点击某标签 -> 列表过滤为该标签关联的 ticket。
- 标题搜索：输入关键字 -> 前端触发搜索接口，返回匹配标题的 ticket。

## 4. 功能需求
- Ticket
  - 必填：标题（<= 200 字符）。
  - 选填：描述（文本）。
  - 状态：`open` / `done`。默认 `open`。
  - 时间：创建时间、更新时间（后端生成）。
  - 删除：物理删除。
- 标签
  - 标签名唯一（大小写不敏感，可在 DB 层使用 lower 索引或统一小写存储）。
  - 创建/删除标签；删除标签时解除与 ticket 的关联。
  - 一个 ticket 可关联多个标签。
- 浏览与筛选
  - 列表默认按创建时间倒序。
  - 可按多个标签过滤（AND 关系：必须同时包含所选标签）。
  - 可按标题关键词搜索（大小写不敏感，前缀/包含匹配）。
  - 状态过滤：全部/open/done。
- 完成与撤销
  - 切换状态应更新 `updated_at`。
- 校验与错误
  - 标题必填、长度校验；标签名非空、长度合理（建议 <= 50 字符）。
  - 后端返回一致的错误格式：`{ "error": { "code": "...", "message": "...", "details": {} } }`。
- 性能与分页
  - 列表分页支持 `limit/offset`，默认 20，最大 100。
  - 搜索/过滤应复用分页。

## 5. 非功能需求
- 性能：典型请求 < 200ms（后端处理），单页列表 < 200 条。
- 可靠性：接口错误需返回明确错误码与可读 message。
- 可运维性：结构化日志；基础健康检查接口。
- 安全：启用 CORS（仅允许前端域名）、限制请求体大小、基础输入校验。

## 6. 数据模型（Postgres）
- `tickets`
  - `id` UUID PK
  - `title` varchar(200) NOT NULL
  - `description` text NULL
  - `status` varchar(10) NOT NULL default 'open' CHECK in ('open', 'done')
  - `created_at` timestamptz NOT NULL default now()
  - `updated_at` timestamptz NOT NULL default now()
- `tags`
  - `id` UUID PK
  - `name` varchar(50) NOT NULL UNIQUE (可用 lower(name) 创建唯一索引)
  - `created_at` timestamptz NOT NULL default now()
- `ticket_tags`
  - `ticket_id` UUID FK -> tickets(id) ON DELETE CASCADE
  - `tag_id` UUID FK -> tags(id) ON DELETE CASCADE
  - PK(ticket_id, tag_id)
- 索引建议
  - `tickets(status)`
  - `tickets(lower(title))` 支持不区分大小写搜索
  - `ticket_tags(tag_id)`

## 7. API 设计（FastAPI）
- 错误响应统一：HTTP 状态码 + 上述错误结构。
- Endpoints
  - `GET /health`：健康检查。
  - `GET /tickets`：查询列表，查询参数：`status`、`tags`（逗号分隔多个 tag name 或 id，AND 逻辑）、`q`（标题关键词）、`limit`、`offset`。返回包含 total、items。
  - `POST /tickets`：创建。请求体：`title`、`description?`、`tags?`（名称数组或 id 数组，需约定一种，建议名称）。返回 ticket 含标签。
  - `GET /tickets/{id}`：获取详情。
  - `PATCH /tickets/{id}`：部分更新（title/description/status/tags）。
  - `DELETE /tickets/{id}`：删除。
  - `GET /tags`：列出所有标签（可按名称模糊过滤 `q`）。
  - `POST /tags`：创建标签。
  - `DELETE /tags/{id}`：删除标签（解除关联）。
- 业务规则
  - 标签名称幂等创建：创建时若已存在同名标签，返回已有标签（或 409 + 提示，需前后端约定，推荐幂等返回已存在标签）。
  - 更新标签列表时覆盖式：传入的标签集合成为新的集合，后端完成增删。

## 8. 后端实现要点
- FastAPI 路由与 Pydantic schema：分 request/response model，统一校验与默认值。
- 数据访问：使用 async ORM 或查询构建器（如 SQLAlchemy async）。事务覆盖创建/更新/标签同步。
- 标签处理：
  - 统一将标签名以小写存储；返回原样展示可与存储同名。
  - 批量 upsert 标签后再写入 `ticket_tags`。
- 搜索与过滤：
  - 标题搜索使用 `ILIKE '%q%'`。
  - 多标签过滤用 `ticket_tags` 分组计数匹配所选标签数以实现 AND。
- 日志：结构化输出（JSON），记录路径、状态码、耗时、错误。
- 健康检查：数据库连通性探测。

## 9. 前端设计（TS/Vite/Tailwind/Shadcn）
- 路由与页面
  - 主列表页：展示 tickets，支持状态筛选、标签过滤、搜索、分页。
  - 创建/编辑表单：弹窗或侧边面板。
  - 详情视图（可选）：在列表行展开或独立页面。
- 组件
  - TicketList：表格/卡片，含状态切换按钮、标签展示。
  - TicketForm：表单（标题必填、描述、标签选择/创建），保存后刷新列表。
  - TagSelector：多选下拉 + 新增标签输入。
  - FiltersBar：状态筛选、标签过滤、搜索框。
  - Pagination：分页器。
- 状态管理与数据获取
  - 推荐使用 React Query/SWR 管理请求缓存、乐观更新（完成/撤销、标签更新）。
  - 接口错误提示 toast；表单内联校验提示。
  - 搜索防抖（300ms）。
- UI/UX
  - 状态切换按钮需可快速恢复（撤销完成即再次点击）。
  - 标签以芯片展示，可点击触发过滤。
  - 长描述折叠/展开。
  - 删除操作二次确认。

## 10. 校验与错误处理
- 前端表单校验：标题必填、长度限制；标签名非空。
- 后端校验：重复标签名处理、状态枚举、分页上限。
- 统一错误提示：网络错误、校验错误、服务器错误分别提示。

## 11. 部署与配置
- Python 版本：3.11+，依赖管理使用 `uv`（替代 pip/poetry），统一通过 `uv sync` 安装。
- Postgres：默认本地数据库，用户名 `postgres`、密码 `postgres`（开发环境）；`DATABASE_URL` 需显式配置。
- 环境变量示例：`DATABASE_URL`、`APP_PORT`、`ALLOWED_ORIGINS`、`LOG_LEVEL`。
- 运行：后端 uvicorn，前端 Vite 构建；提供 docker-compose 示例（可选）。
- 迁移：使用 Alembic 管理数据库迁移。

## 12. 验收标准
- 能创建/编辑/删除 ticket，状态可切换且持久化。
- 标签可创建/删除，标签过滤为 AND 逻辑，删除标签后对应 ticket 仍存在。
- 标题搜索可返回匹配结果，分页正常工作。
- 接口错误返回统一格式；必填项缺失能给出可读提示。
- 健康检查可用，列表默认按创建时间倒序。

## 13. 后续可选扩展
- 排序选项（更新时间、标题）。
- 软删除与回收站。
- 标签颜色/排序。
- 导出/导入（CSV/JSON）。
- 更丰富的过滤（按时间范围）。
