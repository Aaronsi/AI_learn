### DB Query Tool API Tests
### VS Code REST Client Extension Required
### https://marketplace.visualstudio.com/items?itemName=humao.rest-client

@baseUrl = http://localhost:8000
@dbName = postgres

### Variables
# @name dbName
# test_db

### 1. Health Check
GET {{baseUrl}}/health

### 2. Get All Databases (Empty initially)
GET {{baseUrl}}/api/v1/dbs

### 3. Add/Update Database Connection
# @name addDb
PUT {{baseUrl}}/api/v1/dbs/{{dbName}}
Content-Type: application/json

{
  "url": "postgresql://postgres:postgres@localhost:5432/postgres"
}

### 4. Get All Databases (After adding)
GET {{baseUrl}}/api/v1/dbs

### 5. Get Database Metadata
# Note: Metadata is fetched asynchronously, may need to wait a few seconds
GET {{baseUrl}}/api/v1/dbs/{{dbName}}

### 6. Execute SQL Query
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query
Content-Type: application/json

{
  "sql": "SELECT version()"
}

### 7. Execute SQL Query - Select from table
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query
Content-Type: application/json

{
  "sql": "SELECT * FROM information_schema.tables LIMIT 5"
}

### 8. Execute SQL Query - Test LIMIT auto-add
# This query doesn't have LIMIT, should be auto-added
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query
Content-Type: application/json

{
  "sql": "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'"
}

### 9. Natural Language Query
# Generate SQL from natural language
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query/natural
Content-Type: application/json

{
  "prompt": "查询所有表名"
}

### 10. Natural Language Query - English
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query/natural
Content-Type: application/json

{
  "prompt": "Show me all tables in the public schema"
}

### 11. Error Test - Invalid SQL (INSERT not allowed)
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query
Content-Type: application/json

{
  "sql": "INSERT INTO test VALUES (1)"
}

### 12. Error Test - SQL Syntax Error
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query
Content-Type: application/json

{
  "sql": "SELECT * FROM WHERE"
}

### 13. Error Test - Non-existent Database
GET {{baseUrl}}/api/v1/dbs/nonexistent_db

### 14. Error Test - Non-existent Database Metadata
GET {{baseUrl}}/api/v1/dbs/nonexistent_db

### 15. Error Test - Invalid Connection URL
PUT {{baseUrl}}/api/v1/dbs/invalid_db
Content-Type: application/json

{
  "url": "postgresql://invalid:invalid@invalid:5432/invalid"
}

### 16. Add Another Database
PUT {{baseUrl}}/api/v1/dbs/production_db
Content-Type: application/json

{
  "url": "postgresql://user:password@host:5432/database"
}

### 17. Get All Databases (Multiple)
GET {{baseUrl}}/api/v1/dbs

### 18. Update Existing Database
PUT {{baseUrl}}/api/v1/dbs/{{dbName}}
Content-Type: application/json

{
  "url": "postgresql://postgres:postgres@localhost:5432/mydb"
}

### 19. Complex SQL Query
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query
Content-Type: application/json

{
  "sql": "SELECT table_schema, table_name, table_type FROM information_schema.tables WHERE table_schema NOT IN ('pg_catalog', 'information_schema') ORDER BY table_schema, table_name LIMIT 10"
}

### 20. Natural Language Query - Complex
POST {{baseUrl}}/api/v1/dbs/{{dbName}}/query/natural
Content-Type: application/json

{
  "prompt": "查询 public schema 中所有表的名称和类型，按表名排序"
}

